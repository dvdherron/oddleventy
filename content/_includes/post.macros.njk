{% import 'birds.macros.njk' as birds %}
{% import 'layout.macros.njk' as layout %}
{% import 'embed.macros.njk' as embed %}
{% import 'utility.macros.njk' as utility %}

{# @docs
label: Post Macros
category: file
#}

{# @docs
label: by_year
category: lists
note: |
  Group posts by year,
  when there are more than
  a set (`above`) number of posts
params:
  posts:
    type: array
    note: containing 11ty page objects
  collections:
    type: 11ty collections object
    default: none
  above:
    type: number
    default: 6
#}
{% macro by_year(
  posts,
  collections=none,
  above=6
) %}
  {%- if posts -%}
    {%- if posts | length > above -%}
      {%- for group in posts | byYear -%}
        {{ layout.title(group.year) }}
        {{ list(group.posts, collections) }}
      {%- endfor -%}
    {%- else -%}
      {{ layout.title('Resources') }}
      {{ list(posts, collections) }}
    {%- endif -%}
  {%- endif -%}
{% endmacro %}

{# @docs
label: list
category: lists
note: Generate a list of posts
params:
  posts:
    type: array
    note: containing 11ty page objects
  collections:
    type: 11ty collections object
    default: none
#}
{% macro list(
  posts,
  collections=none
) %}
{%- if posts -%}
  {%- set posts = posts if (posts[0].sort) else posts | pageYears  -%}
  {%- set sort = 'sort' if (posts[0].sort) else 'date' -%}

  <ol data-grid="resources" reversed>
    {%- for post in posts | sort(true, false, sort) -%}
      {%- set feature = 'large' if (loop.length == 1) else none -%}
      {%- set feature = 'small' if (feature or post.data.feature) and (loop.length == 2) else feature -%}
      {{ item(post, collections, feature) }}
    {%- endfor -%}
  </ol>
{% endif %}
{% endmacro %}

{# @docs
label: item
category: posts
note: Generate each post in a list
params:
  post:
    type: 11ty page object
  collections:
    type: 11ty collections object
    default: none
  feature:
    type: boolean | 'large'
    default: none
#}
{% macro item(
  post,
  collections=none,
  feature=none
) %}
  {%- set type = post.data.tags | pageType -%}
  {%- set feature = post.event.feature if (post.event and not feature) else feature -%}
  {%- set feature = feature or post.data.feature -%}
  {%- set feature = 'small' if feature and not feature | typeCheck('string') else feature -%}

  <li data-post="{{ type | slug if type else 'default' }}" {{ utility.attr_if('data-feature', feature) }}>
    {%- if feature == 'large' -%}
      {{ type_link(type, collections) }}
      {{ large(post, collections) }}
    {%- else -%}
      {{ small(post, collections, feature) }}
      {{ type_link(type, collections) }}
    {%- endif -%}
  </li>
{% endmacro %}

{# @docs
label: small
category: posts
note: Content for a small card resource
params:
  post:
    type: 11ty page object
  collections:
    type: 11ty collections object
    default: none
  feature:
    type: boolean | 'large'
    default: none
#}
{% macro small(
  post,
  collections=none,
  feature=none
) %}
  <article data-card="link">
    <div class="card-inner">
      {% if feature and post.data.image and not (post.data.image.type == 'media') %}
        {{ hero(post.data.image, 'card') }}
      {% endif %}
      <div class="post-header">
        {{ banner(post) }}
        {{ subtitle(post.data.sub) }}
        {{ byline(post, collections, false) }}
      </div>
      {{ upcoming(post.data.events, links=false) }}
    </div>
  </article>
{% endmacro %}

{# @docs
label: large
category: posts
note: Content for a large featured resource
params:
  post:
    type: 11ty page object
  collections:
    type: 11ty collections object
    default: none
#}
{% macro large(
  post,
  collections=none
) %}
  {%- set content -%}
    <div class="post-header">
      {{ banner(post) }}
      {{ subtitle(post.data.sub) }}
      {{ byline(post, collections) }}
      {{ taglist(post.data.tags, collections) }}
    </div>

    <div class="summary">
      {{ post.data.summary | md | safe }}
      {{ upcoming(post.data.events) }}
    </div>
  {%- endset -%}
  {%- set image = post.data.image -%}
  <article data-card="{{ 'media' if (image.type === 'media') else 'hero' }}">
    {%- if image and (image.type === 'media') -%}
      {{ embed.media_block(
        media=embed.svg(image.svg, image.alt) if image.svg else embed.img(image.src, image.alt),
        name='hero',
        attrs={'data-block': 'rotate'},
        content=content
      ) }}
    {%- else -%}
      {{ hero(image) }}
      {{ content | safe }}
    {%- endif -%}
  </article>
{% endmacro %}

{# @docs
label: upcoming
category: events
note: Listof upcoming events from a post
params:
  events:
    type: array
  links:
    type: boolean
    default: true
    note: Optionally remove event links for content in linked-cards
#}
{% macro upcoming(
  events,
  links=true
) %}
  {%- set events = events | getFuture if events else none -%}
  {%- set events = events | sort(false, false, 'date') -%}
  {%- if events -%}
    <ul class="next-event">
      {%- for next in events -%}
        <li>
          {{ linked(
            next.venue,
            next.url if links else none
          ) }}
          <i>on</i>
          {{ utility.datetime(
            next.date,
            next.end,
            format='md'
          ) }}
        </li>
      {%- endfor -%}
    </ul>
  {%- endif -%}
{% endmacro %}

{# @docs
label: hero
category: metadata
note: Display hero image for a post
params:
  image:
    type: object
  type:
    type: large | card | page
    default: 'large'
#}
{% macro hero(
  image,
  type='large'
) %}
  {%- if image -%}
    <div data-hero="{{ type or 'large' }}">
      {%- if image.src -%}
        {%- set position = {'--hero-position': image.position} | styles -%}
        {{ embed.img(
          src=image.src,
          alt=image.alt,
          attrs={style: position}
        ) }}
      {%- elif image.svg -%}
        {{ embed.svg(image.svg, image.alt) }}
      {%- endif -%}
    </div>
  {%- endif -%}
{% endmacro %}

{# @docs
label: byline
category: metadata
note: |
  Generate the post byline with
  type, authors, venue/client, date, and location
params:
  post:
    type: 11ty page object
  collections:
    type: 11ty collections object
    default: none
  links:
    type: boolean
    default: true
    note: Optionally remove links for content in linked cards
#}
{% macro byline(
  post,
  collections=none,
  links=true
) %}
  <p class="byline">
    {{ byline_type(
      tags=post.data.tags,
      venue=post.data.venue
    ) }}

    {{ by(
      post.data.author,
      collections,
      prefix=none if post.data.venue else 'by',
      link=links
    ) }}

    {% if (post.data.oss == 'core team') %}
      ({{ post.data.oss }})
    {% endif %}

    {{ linked(
      venue=post.data.venue,
      url=(post.data.canonical or post.data.url) if links else none
    ) }}

    {{ client(post.data.client) }}
  </p>
{% endmacro %}

{# @docs
label: byline_type
category: metadata
note: |
  Generate post-type label for the byline
params:
  tags:
    type: array
  venue:
    type: string
    default: none
    note: |
      We don't show type in the byline when a venue is set
#}
{% macro byline_type(
  tags,
  venue=none
) %}
  {%- set type = tags | pageType -%}
  {%- if type and (not venue) and not (type in ['News', 'Links']) -%}
    {%- set byType = {
      'Workshops': 'Workshop',
      'Talks': 'Talk',
      'Videos': 'Video',
      'Podcasts': 'Podcast',
      'OddTools': 'Created'
    } -%}
    <b>{{ byType[type] or type }}</b>
  {%- endif -%}
{% endmacro %}

{# @docs
label: type_link
category: metadata
note: |
  Generate an icon-link
  to the post-type index page
params:
  type:
    type: string
  collections:
    type: 11ty collections object
    default: none
#}
{% macro type_link(
  type,
  collections=none
) %}
  {% set icons = {
    'Client Work': 'tools',
    'OddTools': 'tools',
    'Open Source': 'opensource',
    'Talks': 'talk',
    'Workshops': 'workshop',
    'Podcasts': 'audio',
    'Videos': 'video',
    'Links': 'link',
    'News': 'news'
  } %}
  {{ utility.link_if(
    content=embed.svg(
      path='icons/' + (icons[type] or 'tags'),
      alt=['see all', type] | join(' ') if type else 'all tags'
    ),
    url=collections.all | tagLink(type) if collections else none,
    class='post-type'
  ) }}
{% endmacro %}

{# @docs
label: title
category: metadata
note: Generate a linked heading with the post title
params:
  post:
    type: 11ty page object
#}
{% macro banner(
  post,
  level=3,
  link=true
) -%}
  {%- set title = post | render('banner') or post | render('title') -%}
  {%- set url = post.url if link else none -%}
  {%- h level, {'class': 'post-title'} -%}
    {{ utility.link_if(title | mdInline, url, 'title-link') }}
  {%- endh -%}
{%- endmacro %}

{# @docs
label: subtitle
category: metadata
note: Generate each post in a list
params:
  post:
    type: 11ty page object
  collections:
    type: 11ty collections object
    default: none
#}
{% macro subtitle(
  sub
) %}
  {% if sub %}
    <p class="subtitle">
      {{ sub | mdInline | safe }}
    </p>
  {% endif %}
{% endmacro %}

{# @docs
label: by
category: metadata
note: Show a linked list of authors
params:
  author:
    type: string | array
  collections:
    type: 11ty collections object
#}
{% macro by(
  author,
  collections,
  prefix='by',
  link=true
) %}
  {% if author %}
    {% if prefix %}<i>{{ prefix }}</i>{% endif %}
    {{ birds.authors(author, collections, link) }}
  {% endif %}
{% endmacro %}

{# @docs
label: pubdate
category: metadata
note: Generate a pubdate in the proper format
params:
  start:
    type: date
  end:
    type: date
  format:
    type: string
    default: 'long'
#}
{% macro pubdate(
  start,
  end,
  format='long'
) %}
  {{ utility.datetime(
    start=start,
    end=end,
    format=format,
    is_pubdate=true,
    prefix=true
  ) }}
{% endmacro %}

{# @docs
label: client
category: metadata
note: Show the client name on a client project
params:
  name:
    type: string
#}
{% macro client(name) -%}
  {%- if name %}
    <i>for</i>
    <b>{{ name | mdInline | safe }}</b>
  {% endif -%}
{%- endmacro %}

{# @docs
label: where
category: metadata
note: Show the address when available
params:
  adr:
    type: string
#}
{% macro where(
  adr
) %}
  {% if adr %}
    <i>in</i>
    <span class="adr">
      {{ adr | typogr | safe }}
    </span>
  {% endif %}
{% endmacro %}

{# @docs
label: linked
category: metadata
note: Link to original post or venue
params:
  venue:
    type: string
  url:
    type: url
#}
{% macro linked(
  venue,
  url
) -%}
{%- if venue %}
  <i>at</i>
  {{ utility.link_if(
    content=venue | mdInline | safe,
    url=url,
    class='h-card',
    attrs={'rel': 'bookmark'} if url else none
  ) }}
{% endif -%}
{%- endmacro %}

{# @docs
label: taglist
category: metadata
note: Show a linked list of all post tags, as pills
params:
  tags:
    type: array
  collections:
    type: 11ty collections object
#}
{% macro taglist(
  tags,
  collections,
  pill=true
) -%}
  {%- set public_tags = collections | tagData(tags) -%}
  {%- set public_tags = public_tags if public_tags | length else none -%}

  {%- if public_tags -%}
    <div class="post-tags">
      {%- include "icons/tags.svg" -%}
      <ul class="{{ 'pill-set' if pill else 'inline-list' }}">
        {%- for item in public_tags -%}
          <li class="{{ 'pill-item' if pill else 'inline-item' }}">
            {{- utility.link_if(
              content=item.tag,
              url=item.url,
              class='pill' if pill else none
            ) -}}
          </li>
        {%- endfor -%}
      </ul>
    </div>
  {%- endif -%}
{%- endmacro %}

{# @docs
label: linklist
category: metadata
note: List of links to docs, source, sites, slides, etc
params:
  links:
    type: object
    note: the key will be used as text, with the value for url
  slides:
    type: url
    default: 'none'
#}
{% macro linklist(
  links,
  slides=none
) %}
  {% if links or slides %}
    <ul class="post-links">
      {% if slides %}
        <li>{{ utility.link_if('slides »', slides) }}</li>
      {% endif %}

      {% for name, url in links %}
        <li>{{ utility.link_if(name + ' »', url) }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endmacro %}
